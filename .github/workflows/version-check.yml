name: VersionCheck
on:
  push:
    branches:
      - main
    paths:
      - 'GameModeManager/Config.cs'
      - 'SECURITY.md'
jobs:
  VersionCheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract Versions
        id: extract_versions
        run: |
          PLUGIN_VERSION=$(grep -oP 'ModuleVersion => "\K[^"]+' GameModeManager/Plugin.cs)
          echo "plugin_version=$PLUGIN_VERSION" >> $GITHUB_OUTPUT

          SECURITY_CURRENT=$(grep -oP '\- v\K[^ ]+(?= \*\*\(Current Version\)\*\*)' SECURITY.md)
          echo "security_current=$SECURITY_CURRENT" >> $GITHUB_OUTPUT

          SECURITY_PREVIOUS=$(grep -oP '\- v\K[^ ]+(?= \*\*\(Previous Major Version\)\*\*)' SECURITY.md)
          echo "security_previous=$SECURITY_PREVIOUS" >> $GITHUB_OUTPUT

          CONFIG_CLASS=$(grep -oP 'public\s+int\s+Version\s*{\s*get;\s*set;\s*}\s*=\s*\K\d+' GameModeManager/Config.cs)
          if [[ -z "$CONFIG_CLASS" ]]; then
            echo "Error: Could not find Config Class Version in GameModeManager/Config.cs"
            exit 1
          fi
          echo "config_class=$CONFIG_CLASS" >> $GITHUB_OUTPUT

          CONFIG_PARSED=$(grep -oP 'if\s*\(_config\.Version\s*<\s*\K\d+' GameModeManager/Config.cs)
          if [[ -z "$CONFIG_PARSED" ]]; then
            echo "Error: Could not find Config Parsed Version check in GameModeManager/Config.cs"
            exit 1
          fi
          echo "config_parsed=$CONFIG_PARSED" >> $GITHUB_OUTPUT

      - name: Calculate Expected Previous Version
        id: calculate_previous_version
        run: |
          CURRENT_VERSION="${{ steps.extract_versions.outputs.plugin_version }}"
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid plugin version format found: $CURRENT_VERSION"
            exit 1
          fi
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          if [[ $PATCH -gt 0 ]]; then
            EXPECTED_PREVIOUS="$MAJOR.$MINOR.$((PATCH - 1))"
          elif [[ $MINOR -gt 0 ]]; then
            EXPECTED_PREVIOUS="$MAJOR.$((MINOR - 1)).0"
          elif [[ $MAJOR -gt 0 ]]; then
            EXPECTED_PREVIOUS="$((MAJOR - 1)).0.0"
          else
            echo "Warning: Cannot determine previous version for $CURRENT_VERSION"
            EXPECTED_PREVIOUS="0.0.0"
          fi
          echo "expected_previous_version=$EXPECTED_PREVIOUS" >> $GITHUB_OUTPUT

      - name: Check Version Consistency
        run: |
          PLUGIN="${{ steps.extract_versions.outputs.plugin_version }}"
          SECURITY_CURRENT="${{ steps.extract_versions.outputs.security_current }}"
          SECURITY_PREVIOUS="${{ steps.extract_versions.outputs.security_previous }}"
          EXPECTED_PREVIOUS="${{ steps.calculate_previous_version.outputs.expected_previous_version }}"
          CONFIG_CLASS="${{ steps.extract_versions.outputs.config_class }}"
          CONFIG_PARSED="${{ steps.extract_versions.outputs.config_parsed }}"

          ERROR_DETECTED=false

          echo "--- Version Check ---"
          echo "Plugin.cs version: $PLUGIN"
          echo "SECURITY.md Current Version: $SECURITY_CURRENT"
          echo "SECURITY.md Previous Version: $SECURITY_PREVIOUS"
          echo "Calculated Expected Prev Version: $EXPECTED_PREVIOUS"
          echo "Config.cs (Class) Version: $CONFIG_CLASS"
          echo "Config.cs (Parsed Check) Version: $CONFIG_PARSED"
          echo "---------------------"

          if [[ "$PLUGIN" != "$SECURITY_CURRENT" ]]; then
            echo "Error: Plugin version mismatch!"
            echo "Plugin.cs version: $PLUGIN"
            echo "SECURITY.md Current Version: $SECURITY_CURRENT"
            ERROR_DETECTED=true
          fi

          if [[ "$EXPECTED_PREVIOUS" != "0.0.0" && "$SECURITY_PREVIOUS" != "$EXPECTED_PREVIOUS" ]]; then
            echo "Error: Previous plugin version mismatch!"
            echo "SECURITY.md Previous Version: $SECURITY_PREVIOUS"
            echo "Expected Previous Version: $EXPECTED_PREVIOUS"
            ERROR_DETECTED=true
          elif [[ "$EXPECTED_PREVIOUS" == "0.0.0" ]]; then
            echo "Warning: Skipping previous version check due to calculation issue for $PLUGIN."
          fi

          if [[ "$CONFIG_CLASS" != "$CONFIG_PARSED" ]]; then
            echo "Error: Config version mismatch!"
            echo "Config.cs (Class) Version: $CONFIG_CLASS"
            echo "Config.cs (Parsed Check) Version: $CONFIG_PARSED"
            ERROR_DETECTED=true
          fi

          if [[ "$ERROR_DETECTED" == true ]]; then
            echo "Version consistency checks failed."
            exit 1 # Fail the workflow
          else
            echo "Versions are consistent."
          fi